:docinfo:
:toc: 
:toc-title: PCW User Guide
= ProActive Cloud Watch (PCW)
include::../common-settings.adoc[]
include::../all-doc-links.adoc[]

== Main concepts of PCW

*ProActive Cloud Watch (PCW)* monitors a system, and according to some rules, detects complex events, and trigger actions when configured events are fired. +
PCW defines *rules*, which describe the metrics to monitor, triggering conditions and action when the conditions are met. +

ProActive Cloud Watch is organized as a catalog of rules (which can be activated or deactivated) that will automatically trigger user-specified actions if defined conditions are fulfilled. +
For example PCW is able to monitor some computing resources (ProActive Nodes) and deploy new resources (scale up) when the monitored resources are overloaded. Another use-case is to notify users with alerts about degradation of some resources. +
In general PCW allows to trigger any action via submitting a workflow to the ProActive Scheduler.

*Definitions:*

Rule:: - defines a monitoring part, triggering conditions and action. Rules generally use a template for certain monitoring use-cases and parameterize this template using variables.
Rule Instance:: - instantiated rule with concrete set of variables. One Rule can have several Rule Instances with different values of variables. The rule instance can be activated/deactivated. When the rule instance is activated, it will start a monitoring defined inside the rule.
image::PCW-General-overview.jpg[align=center]
The diagram above illustrates the general overview of PCW functionality.

=== Monitoring

There are several types of metrics that can be monitored by PCW. Proactive Cloud Watch implements a polling mechanism to collect the monitoring metrics. A delay can also be added to resume monitoring after an action has been triggered only after a certain time. This feature is very useful in case of scale up/down use-cases and helps to avoid triggering extra actions until the new resource is deploying/undeploying. +
The design of PCW allows to add new types of monitoring metrics.

==== Monitoring physical metrics
ProActive provides a way to monitor system metrics of virtual and physical machines (Nodes) deployed by ProActive Resource Manager. +
Thanks to the JMX protocol, Proactive Nodes can expose many system metrics from the underlying operating system (disk, ram, cpu usage, network activity, etc...).
Proactive Nodes use the  https://github.com/hyperic/sigar[Sigar^] library to collect physical metrics. +

ProActive Cloud watch can monitor any ProActive Node JMX url to access the following metrics:

* System memory, swap, cpu, load average, uptime, logins.
* Per-process memory, cpu, credential info, state, arguments, environment, open files.
* File system threshold detection and metrics.
* Network interface detection, configuration information and metrics.
* Network route and connection tables.

==== Monitoring host accessibility
Another type of monitoring available in PCW is to check host accessibility. The implementation of this metric follows the `ping` host approach. With help of this metric a user can easily check if a host is down (or up) and in this case automatically trigger an action.

=== Processing mechanism
The core of rule processing is managed by the https://www.drools.org/[Drools Engine^] for performance processing of collected metrics. It features powerful mechanisms for complex event processing. The advanced Drools algorithm helps fast detection of fulfilling the conditions and triggering actions.

=== Rule’s Action
According to the concepts of PCW, the action will be triggered when specified condition is met. +
In order to make an action flexible to any user needs, the rule’s action is firing a job inside scheduler. A user just need to specify which workflow from Catalog will be fired as Rule’s action. +
For example, a user can design an action workflow that will send notification (alert) if some metric has reached a critical value. +
For scalability use-case a Rule’s action can be staring of the Cloud Automation service that will deploy new resources.

== PCW portal -  Using existing rules

In Automation Dashboard portal, the Cloud Watch view allows users to activate and parametrize a predefined set of rules and also to create new ones.

The next screenshot illustrates PCW portal.

image::automation-dashboard-cloud-watch.PNG[align=center]

The portal is divided in several sections:

1. In the `Rules` panel a user can find the set of predefined PCW rules ready to be activated.
2. `Activated Rule Instances` panel shows all rules instances after activation with certain variables.
3. `Rule - Fired Jobs` table provides information about triggered jobs inside Scheduling as action of activated rules.
4. `Removed Rule Instances` panel gives the list of all rule instances that were removed from the list of activated rules.

In order to better understand the usage of PCW portal, let’s take an example of using existing PCW rules provided by the ProActive distribution.

=== Activating a Rule

Here is an example to illustrate simple use-case of PCW with portal.

The next screenshot shows how to activate a rule, when a user selects the certain rule from list of `Rules`.

image::PCW-rule activation.PNG[align=center]

A user can change the default values. +
A user should *Obtain a JMX node url* and paste the value in the _nodeUrlVar_ variable. +
After modifying the variables a user can *Check* (validate) the rule or directly *Activate* it.

=== Using Rule variables
The rule variables depend on the definition and purpose of the rule. There are different variables for different rules. The designer of a new rule can choose the set of variables needed.

Let’s give explanation of rules for our example:

- nodeUrlVar - url of the JMX endpoint what will be monitored
- pollingPeriodInSecondsVar - time frequence when collecting metrics from monitored resource
- calmPeriodInSecondsVar - time period during which the metrics are not collected after the rule action was triggered
- workflowNameAsActionVar - name of the workflow inside ProActive Catalog that will be fired as action
- bucketNameAsActionVar - name of the catalog bucket identifying the workflow that will be fired as action
- usageCombinedCPUMetric - specific Sigar metric for this rule, identifying combined CPU usage kpi
- percentageUsedLimit - threshold of percentage used CPU metric which will trigger the action. This variable is directly connected with the rule condition.

=== Activated Rule Instances
After activation of a *rule*, the instance will appear in section `Activated Rule Instances`.

All the activated rule instances are monitoring the specified resources. If the triggering condition is met, then the rule will fire the job. This fired job description will appear in `Rule - Fired Jobs` table. The monitoring and triggering actions can be stopped by removing an Activated rule instance. After removing rule instance from active list, it will appear in `Removed Rule Instances table`. It’s possible to see the history of all fired jobs for removed rule instance.

This behaviour is demonstrated on the next screenshot.

image::PCW-activated-with-removed.PNG[align=center]

=== Obtaining JMX node urls
ProActive Resource Manager portal provides access to monitoring abilities. During the activation of a rule, a user should enter as rule parameter a JMX endpoint corresponding to the monitored resource (for example a ProActive Node). +
In order to get this information for a Node, a user can go to *RM portal*, click with the right button on the Node which should be monitored and click `Copy JMX Endpoint`. Then a user can come back to *Cloud Watch* portal and paste the JMX url in corresponding field.

image::RM-copy-jmx-ur.PNG[align=center]
